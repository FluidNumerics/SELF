name: CI

on:
  push:
    
    paths-ignore:
      - 'AUTHORS.md'
      - 'LICENSE.md'
      - 'README.md'
  pull_request:
    paths-ignore:
      - 'AUTHORS.md'
      - 'LICENSE.md'
      - 'README.md'

env:
  PROJECT_ID: self-fluids
  GAR_LOCATION: us-west1
  REPOSITORY: self
  IMAGE: main

jobs:
  build:
    name: Docker build and push
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        include:
          - rocm_version: '5.4.6'
            precision: double
            gpu_target: gfx906
            hip_platform: amd
            fflags: '-cpp -pg -g -O0 -C -Wall -fbounds-check -fbacktrace --coverage -ffpe-trap=invalid,zero,overflow'
            coverage: true

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: 'Docker build'
      run: |-
        docker build \
         --build-arg GPU_TARGET=${{ matrix.gpu_target }} \
         --build-arg HIP_PLATFORM=$${{ matrix.hip_platform }} \
         --build-arg PREC=${{ matrix.precision }} \
         --build-arg FFLAGS="${{ matrix.fflags }}" \
         --tag "us-docker.pkg.dev/self-fluids/self/base_rocm-${{ matrix.rocm_version }}_cuda-11.8.0_${{ matrix.gpu_target }}_${{ matrix.precision }}:$GITHUB_SHA" \
          .

    - name: Convert docker to singularity 
      run: |
        apptainer pull self.sif \
        docker-daemon:us-docker.pkg.dev/self-fluids/self/base_rocm-${{ matrix.rocm_version }}_cuda-11.8.0_${{ matrix.gpu_target }}_${{ matrix.precision }}:$GITHUB_SHA"

    - name: Run tests for coverage
      run: |
        apptainer exec --rocm --bind $(pwd):/build self.sif /opt/self/ci/test.sh

    - uses: codecov/codecov-action@v3
      if: ${{ matrix.coverage }}
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./lcov.info
        flags: unittests
        name: codecov-umbrella

    - name: Coveralls
      if: ${{ matrix.coverage }}
      uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.COVERALLS_REPO_TOKEN }}
        path-to-lcov: ./lcov.info

    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v0'
      with:
        token_format: access_token
        workload_identity_provider: projects/163522599797/locations/global/workloadIdentityPools/ghactions/providers/github
        service_account: github-cloudbuild@self-fluids.iam.gserviceaccount.com	
        access_token_lifetime: 300s

    - name: Login to Artifact Registry
      uses: docker/login-action@v1
      with:
        registry: us-docker.pkg.dev
        username: oauth2accesstoken
        password: ${{ steps.auth.outputs.access_token }}

    - name: 'Push to artifact registry'
      run: |-
        docker push \
        "us-docker.pkg.dev/self-fluids/self/base_rocm-${{ matrix.rocm_version }}_cuda-11.8.0_${{ matrix.gpu_target }}_${{ matrix.precision }}:$GITHUB_SHA"
