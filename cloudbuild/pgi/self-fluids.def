Bootstrap: docker
From: gcr.io/self-fluids/pgi:latest

%help


%setup


%files

/workspace

%post

   #Nvidia driver file mount paths
   mkdir /cuda

   #Add nvidia driver paths to the environment variables
   echo 'export PATH="/cuda/bin:$PATH"' >> $SINGULARITY_ENVIRONMENT
   echo 'export LD_LIBRARY_PATH="/cuda/lib:$LD_LIBRARY_PATH"' >> $SINGULARITY_ENVIRONMENT

#   export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/lib
#   export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/hdf5/lib
#   export PATH=${PATH}:/usr/local/hdf5/bin

   cd ${SINGULARITY_ROOTFS}/workspace 
   autoreconf --install
   FCFLAGS="-O3" cuda_toolkit_version="cuda10.0"\
   ${SINGULARITY_ROOTFS}/workspace/configure --enable-diagnostics \
                                             --enable-tecplot \
                                             --enable-cuda \
                                             --with-metis=/usr/local/metis/lib/libmetis.a \
                                             --with-hdf5=/usr/local/hdf5/bin/h5cc \
                                             --prefix=/usr/local/self-fluids
   make
   make install

   mkdir -p /samples
   cp -r ${SINGULARITY_ROOTFS}/workspace/examples/* /samples/


%environment

%test
   
/usr/local/self-fluids/bin/sfluid --param-file /samples/thermalbubble/runtime.params \
                                  --equation-file /samples/thermalbubble/self.equations

%labels

